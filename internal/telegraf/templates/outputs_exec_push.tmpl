{{if and (hasPrefix .Metric "docker_container_") .ContainerName -}}
############################################
# Docker metric isolation (auto-generated) - UPDATED
# Uses clone + rename to preserve original metrics for InfluxDB
############################################
[[processors.clone]]
  namepass = ["{{.Metric}}"]
  tagpass = { container_name = ["{{.ContainerName}}"] }
  [processors.clone.tags]
    uk_clone = "true"
[[processors.rename]]
  namepass = ["{{.Metric}}"]
  tagpass = { uk_clone = ["true"] }
  [[processors.rename.replace]]
    measurement = "{{.Metric}}"
    dest = "{{.Metric}}_{{sanitizeMetric .ContainerName}}"
{{end -}}
############################################
# Push to Uptime Kuma
############################################
[[outputs.exec]]
  command = [
    "docker",
    "run",
    "--rm",
    "-i",
    "-v", "/etc/uptime-kuma-agent:/config:ro",
    "-v", "{{.HostLogDirectory}}:{{.InternalLogDirectory}}",
    "{{.DockerImage}}",
    "push-metric",
    "--monitor", "{{.MonitorName}}",
    "--group", "{{.Group}}",
    "--token", "{{.Token}}"
  ]

  {{if and (hasPrefix .Metric "docker_container_") .ContainerName -}}
  namepass = ["{{.Metric}}_{{sanitizeMetric .ContainerName}}"]
  tagpass = { uk_clone = ["true"] }
  tagexclude = ["uk_clone"]
  {{else -}}
  namepass = ["{{.Metric}}"]
  {{end -}}
  fieldinclude = ["{{.Field}}"]

{{if .Filesystem -}}
  [outputs.exec.tagpass]
    path = ["{{.Filesystem}}"]
{{end -}}
